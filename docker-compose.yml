version: "3.8"

services:
  goaccess:
    image: allinurl/goaccess:latest
    container_name: goaccess
    command: >
      sh -c '
        mkdir -p /opt/goaccess/db /var/www/html &&
        touch /logs/access.log &&
        goaccess /logs/*.log
          --real-time-html
          --persist --restore
          --db-path=/opt/goaccess/db
          --html-report-title="Synology Nginx Real-Time Dashboard"
          -p /etc/goaccess/goaccess.conf
          -o /var/www/html/report.html
          --daemonize
          --addr=0.0.0.0
          --port=7890
      '
    volumes:
      - ${GOACCESS_DB_DIR:-./data/db}:/opt/goaccess/db
      - ${GOACCESS_HTML_DIR:-./data/html}:/var/www/html
      - ${NGX_LOG_DIR:-/var/log/nginx}:/logs:ro
      - ./goaccess/goaccess.conf:/etc/goaccess/goaccess.conf:ro
    ports:
      - "${WS_PORT:-7890}:7890"
    restart: unless-stopped

  web:
    image: caddy:2-alpine
    container_name: goaccess-web
    ports:
      - "${DASHBOARD_PORT:-8080}:80"
    volumes:
      - ${GOACCESS_HTML_DIR:-./data/html}:/usr/share/caddy
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    restart: unless-stopped


